<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>[마비노기] 손이 또 미끄러졌네</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 30px;
      margin: 0;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      width: 90%;
      max-width: 400px;
    }

    .layer {
      width: 100%;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0;
    }

    .item-box {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      overflow: hidden;
      border-radius: 10px;
      background: #000;
    }

    .item-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }

    .level-display {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 4px 8px;
      font-weight: bold;
      border-radius: 5px;
      font-size: 14px;
    }

    .info-box {
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-weight: bold;
      color: #333;
      font-size: 14px;
      width: 100%;
      padding: 15px;
      box-sizing: border-box;
    }

    .info-box input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 5px;
    }

    .pity-bar-container {
      width: 100%;
      height: 16px;
      background: #eee;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 4px;
    }

    .pity-bar {
      height: 100%;
      width: 0%;
      background: #444;
      transition: width 0.3s ease;
    }

    .button-box button {
      width: 100%;
      border: 1px solid #333;
      padding: 12px 0;
      font-size: 16px;
      cursor: pointer;
      background: #fff;
      border-radius: 8px;
      font-weight: bold;
      transition: all 0.2s ease;
    }

    .button-box button:hover {
      background: #f0f0f0;
    }

    .button-box button:active {
      transform: translateY(1px);
    }

    .success-anim {
      animation: successAnim 0.5s ease;
    }

    @keyframes successAnim {
      0% { transform: scale(1); }
      25% { transform: scale(1.2); }
      50% { transform: scale(0.9); }
      75% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .fail-anim {
      animation: failAnim 0.5s ease;
    }

    @keyframes failAnim {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(-10deg); }
      50% { transform: rotate(10deg); }
      75% { transform: rotate(-5deg); }
      100% { transform: rotate(0deg); }
    }

  </style>
</head>
<body>

  <div class="game-container">
    <div class="layer item-box">
      <img id="itemImg" src="1.png" alt="아이템">
      <div class="level-display" id="itemLevel">+10강</div>
    </div>

    <div class="layer info-box">
      <div id="chance">강화 확률: 5%</div>
      <label>
        <input type="checkbox" id="catalyst"> 촉매제 사용
      </label>
      <div>
        천장 수치: <span id="pityValue">0%</span>
        <div class="pity-bar-container">
          <div id="pityBar" class="pity-bar"></div>
        </div>
      </div>
      <div>
        파편 <span id="runeCount">0</span>개 / 촉매제 <span id="catalystCount">0</span>개 / <span id="goldCount">0</span>골드
      </div>
    </div>

    <div class="layer button-box">
      <button id="upgradeBtn">강화</button>
    </div>
  </div>

  <script>
    let level = 10; 
    const maxLevel = 20;
    let pity = 0;

    let totalRune = 0;
    let totalGold = 0;
    let totalCatalyst = 0;

    const itemLevel = document.getElementById("itemLevel");
    const chanceDisplay = document.getElementById("chance");
    const upgradeBtn = document.getElementById("upgradeBtn");
    const itemImg = document.getElementById("itemImg");
    const catalystCheckbox = document.getElementById("catalyst");
    const pityValue = document.getElementById("pityValue");
    const pityBar = document.getElementById("pityBar");
    const runeCount = document.getElementById("runeCount");
    const goldCount = document.getElementById("goldCount");
    const catalystCount = document.getElementById("catalystCount");

    const runeCost = [0,0,0,0,0,0,0,0,0,0,344,361,560,846,1207,1375,2407,3094,4125,8251];
    const goldCost = [0,0,0,0,0,0,0,0,0,0,110013,115513,179321,270631,386145,440051,770089,990115,132153,2640305];
    const catalystCost = [0,0,0,0,0,0,0,0,0,0,5,5,5,5,5,9,9,9,9,9];

    function getChance(lv) {
  if (lv < 10) return 100;
  if (lv === 10) return 15;
  if (lv === 11) return 10;
  if (lv === 12) return 7;
  if (lv === 13) return 5;
  if (lv === 14) return 3;
  return 1; // 15강 이상
}

function getPityIncrement(lv, usedCatalyst) {
  const chance = getChance(lv);
  if(lv < 10) return 0; // 10강 이하 천장 없음
  if(usedCatalyst) return chance / 2; // 촉매제 사용 시 현재 확률의 절반
  return chance / 2; // 촉매제 미사용 시도도 절반? 아니면 기존 로직대로 낮게
}

    function updateUI(state="default") {
      itemLevel.textContent = `+${level}강`;

      if(state === "default") itemImg.src = "1.png";
      else if(state === "success") itemImg.src = "2.png";
      else if(state === "fail") itemImg.src = "3.png";

      if (level >= maxLevel) {
        chanceDisplay.textContent = "최대 강화 단계 도달!";
        upgradeBtn.disabled = true;
      } else {
        chanceDisplay.textContent = `강화 확률: ${getChance(level)}%`;
      }

      pityValue.textContent = Math.floor(pity) + "%";
      pityBar.style.width = pity + "%";

      runeCount.textContent = totalRune;
      goldCount.textContent = totalGold;
      catalystCount.textContent = totalCatalyst;
    }

    upgradeBtn.addEventListener("click", () => {
    if (level >= maxLevel) return;

    const baseChance = getChance(level);
    const usedCatalyst = catalystCheckbox.checked;
    const roll = Math.random() * 100;

    // 강화 시 재화 소비
    totalRune += runeCost[level];
    totalGold += goldCost[level];
    if (usedCatalyst) totalCatalyst += catalystCost[level];

    // 애니메이션 제거 + 강제로 reflow
    itemImg.classList.remove("success-anim", "fail-anim");
    void itemImg.offsetWidth; // 브라우저에 강제로 재flow 발생

    // 성공 조건: 확률 성공 OR 천장
    if (roll < baseChance || pity >= 100) {
        level++;
        pity = 0; // 천장 초기화
        itemImg.classList.add("success-anim"); // 성공 애니메이션 적용
        updateUI("success");
        return; // 성공 후 즉시 종료
    }

    // 실패 시
    pity += getPityIncrement(level, usedCatalyst);
    if (pity > 100) pity = 100;

    itemImg.classList.add("fail-anim"); // 실패 애니메이션 적용
    updateUI("fail");
});

    updateUI();
  </script>

</body>
</html>
